version: '3.8'

services:
  umbrel-electrs:
    image: getumbrel/electrs:v0.10.9@sha256:622657fbdc7331a69f5b3444e6f87867d51ac27d90c399c8bf25d9aab020052b
    container_name: umbrel-electrs
    restart: unless-stopped
    ports:
      - "3001:3000"    # HTTP API
      - "50001:50001"  # Electrum RPC
      - "50002:50002"  # Electrum Index RPC
      - "4224:4224"    # Prometheus monitoring
    environment:
      - ELECTRS_NETWORK=bitcoin
      - ELECTRS_DAEMON_RPC_ADDR=umbrel-bitcoin:8332
      - ELECTRS_DAEMON_RPC_USER=umbrel
      - ELECTRS_DAEMON_RPC_PASS=moneyprintergobrrr
      - ELECTRS_DAEMON_P2P_ADDR=umbrel-bitcoin:8333
      - ELECTRS_ELECTRUM_RPC_ADDR=0.0.0.0:50001
      - ELECTRS_ELECTRUM_RPC_ADDR_INDEX=0.0.0.0:50002
      - ELECTRS_HTTP_ADDR=0.0.0.0:3000
      - ELECTRS_VERBOSITY=4
      - ELECTRS_MONITORING_ADDR=0.0.0.0:4224
      - ELECTRS_DB_DIR=/home/electrs/.electrs/db
      - ELECTRS_INDEX_BATCH_SIZE=10
      - ELECTRS_INDEX_LIMIT=1000
      # Tor Configuration
      - TOR_PROXY_IP=umbrel-tor
      - TOR_PROXY_PORT=9050
    volumes:
      - ./data:/home/electrs/.electrs
      # Unraid-specific volume mapping (uncomment for production use)
      # - /mnt/user/appdata/umbrel-electrs:/home/electrs/.electrs
    networks:
      - electrs-network
    depends_on:
      - umbrel-bitcoin  # Bitcoin container dependency
      - umbrel-tor      # Tor daemon dependency
    user: "1000:1000"  # Unraid nobody:users equivalent
    # Alternative user mapping for Unraid
    # user: "99:100"  # nobody:users on Unraid

  # Bitcoin node container for testing
  umbrel-bitcoin:
    image: ghcr.io/getumbrel/umbrel-bitcoin:v1.0.3-core.v29.0@sha256:311d14cf3cb0a49fad7779310521f1abd9242dfcc2f08eb8e3cbff97ca67d6ea
    container_name: umbrel-bitcoin
    restart: unless-stopped
    ports:
      - "8332:8332"  # Bitcoin RPC
      - "8333:8333"  # Bitcoin P2P
    environment:
      - BITCOIN_NETWORK=mainnet
      - BITCOIN_RPC_USER=umbrel
      - BITCOIN_RPC_PASSWORD=moneyprintergobrrr
      - BITCOIN_RPC_BIND=0.0.0.0
      - BITCOIN_RPC_ALLOW_IP=0.0.0.0/0
      - BITCOIN_DISABLE_WALLET=1
      - BITCOIN_TXINDEX=1
      - BITCOIN_BLOCKFILTERINDEX=1
      - BITCOIN_PRUNING=0
    volumes:
      - ./bitcoin-data:/home/umbrel/.bitcoin
      # Unraid-specific volume mapping (uncomment for production use)
      # - /mnt/user/appdata/umbrel-bitcoin:/home/umbrel/.bitcoin
    networks:
      - electrs-network
    user: "1000:1000"  # Unraid nobody:users equivalent
    # Alternative user mapping for Unraid
    # user: "99:100"  # nobody:users on Unraid

  umbrel-tor:
    image: getumbrel/tor:0.4.7.8@sha256:2ace83f22501f58857fa9b403009f595137fa2e7986c4fda79d82a8119072b6a
    container_name: umbrel-electrs-tor
    user: "1000:1000"
    restart: on-failure
    volumes:
      - ./torrc:/etc/tor/torrc:ro
      - ./tor-data:/data
    environment:
      HOME: "/tmp"
    networks:
      electrs-network:
        ipv4_address: 172.21.0.2

networks:
  electrs-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
